# Task 001: 麻雀スコア計算 - ウマ・オカ計算実装

## タスク情報

- **タスクID**: task_001
- **作成日**: 2025-08-28
- **対象ファイル**: `lib/screens/score_input/score_input_screen.dart`
- **関連する箇所**: `_calculate()` メソッド内の `TODO(human)` 部分
- **ステータス**: 未完了

## Context（背景）

麻雀のスコア計算機能の基本実装が完了しました。現在の実装では点棒→点数変換と点数の合計チェックが動作します。しかし、実際の麻雀ゲームでは「ウマ・オカ」の計算が重要です。ウマは順位ボーナス、オカは配給原点からの調整です。

### 現在の実装状況
- ✅ 点棒入力モードと点数入力モードの切り替え
- ✅ 4人分のプレイヤー入力フィールド
- ✅ バリデーション機能（点棒合計100,000点チェック）
- ✅ 基本的な点数計算（点棒 - 25000）
- ❌ ウマ・オカを考慮した最終スコア計算

## Your Task（実装すべき内容）

`score_input_screen.dart`の`_calculate()`メソッド内で、点棒モードの計算ロジックを拡張してください。TODO(human)の箇所で、現在のゲーム情報（basePointとumaOka）を使ってウマ・オカを含む最終スコアを計算する処理を実装してください。

### 実装箇所
```dart
// TODO(human): ウマ・オカ計算を実装
// 1. 各プレイヤーの素点（点棒-basePoint）を計算
// 2. 順位を判定（降順ソート）
// 3. ウマ・オカを適用して最終スコアを計算
```

## Guidance（実装ガイダンス）

### Step 1: 素点計算
各プレイヤーの素点（点棒 - basePoint）を計算してください。
- `currentGame.basePoint`を使用（通常は25000）
- 結果は点数単位で保持

### Step 2: 順位判定
素点に基づいて順位を判定してください。
- 降順ソート（高い点数が上位）
- 同点の場合の処理も考慮
- 元のプレイヤーインデックスを保持

### Step 3: ウマ・オカ適用
順位に応じてウマ・オカを適用してください。
- 1位: `+currentGame.umaOka`点
- 4位: `-currentGame.umaOka`点  
- 2位・3位: 按分（例：1位と4位の中間値）
- 最終スコア = (素点 + ウマ・オカ) / 1000

### 考慮事項
- 小数点以下の処理
- 4人の最終スコア合計が0になることを確認
- エラーハンドリング

### 参考データ構造
```dart
// ゲーム情報（利用可能）
final currentGame = ref.watch(currentGameProvider);
// currentGame.basePoint: 配給原点（通常25000）
// currentGame.umaOka: ウマ・オカ点数

// 入力データ
final actualPoints = values.map((v) => v * 100).toList(); // 点棒
```

## 実装完了の確認項目

- [ ] basePointを使用した素点計算
- [ ] 正確な順位判定ロジック
- [ ] ウマ・オカの適用
- [ ] 最終スコアの1000点換算
- [ ] 合計が0になることの確認
- [ ] エラーハンドリング

---

**注意**: このタスクが完了したら、`task_learning.md`のステータスを更新し、完了したタスクリストに移動してください。